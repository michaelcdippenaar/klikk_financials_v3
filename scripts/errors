#!/bin/bash
# View only errors from gunicorn logs
# Usage: ./errors

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

SERVICE_NAME="klikk-financials"
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  Gunicorn Errors${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""
echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
echo ""

# Error patterns to search for
ERROR_PATTERNS="error|Error|ERROR|exception|Exception|EXCEPTION|traceback|Traceback|TRACEBACK|failed|Failed|FAILED|timeout|Timeout|TIMEOUT|SystemExit|500|504"

# Check if using systemd service
if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
    echo -e "${YELLOW}Following errors from systemd service logs...${NC}"
    echo ""
    sudo journalctl -u "$SERVICE_NAME" -n 100 -f | grep -iE "$ERROR_PATTERNS" --color=always
elif pgrep -f "gunicorn.*klikk_business_intelligence.wsgi" > /dev/null; then
    echo -e "${YELLOW}Gunicorn process found${NC}"
    
    # Check for log files
    if [ -f "/var/log/gunicorn/error.log" ]; then
        echo "Following errors: /var/log/gunicorn/error.log"
        tail -f /var/log/gunicorn/error.log | grep -iE "$ERROR_PATTERNS" --color=always
    elif [ -f "$PROJECT_DIR/logs/gunicorn-error.log" ]; then
        echo "Following errors: $PROJECT_DIR/logs/gunicorn-error.log"
        tail -f "$PROJECT_DIR/logs/gunicorn-error.log" | grep -iE "$ERROR_PATTERNS" --color=always
    else
        echo -e "${YELLOW}No log files found. Try: sudo journalctl -u $SERVICE_NAME -f | grep -iE '$ERROR_PATTERNS'${NC}"
    fi
else
    echo -e "${RED}Gunicorn service not found or not running.${NC}"
    echo "Check service status: sudo systemctl status $SERVICE_NAME"
    exit 1
fi
